# Rework a PR based on review feedback
#
# Usage:
#   lok run rework-pr 31
#
# This workflow:
# 1. Checks out the PR branch
# 2. Fetches review comments and current diff
# 3. Gets fix proposals from multiple backends
# 4. Synthesizes consensus fix
# 5. Applies fixes, commits, and pushes to update the PR

name = "rework-pr"
description = "Rework a PR based on review feedback"

[[steps]]
name = "fetch-pr"
shell = "gh pr view {{ arg.1 }} --json number,title,body,headRefName,baseRefName"

[[steps]]
name = "checkout"
depends_on = ["fetch-pr"]
shell = "git fetch origin {{ steps.fetch-pr.headRefName }} && git checkout {{ steps.fetch-pr.headRefName }}"

[[steps]]
name = "fetch-diff"
depends_on = ["checkout"]
shell = "gh pr diff {{ arg.1 }}"

[[steps]]
name = "fetch-comments"
depends_on = ["checkout"]
shell = "gh pr view {{ arg.1 }} --json comments --jq '.comments[].body'"

[[steps]]
name = "fetch-reviews"
depends_on = ["checkout"]
shell = "gh pr view {{ arg.1 }} --json reviews --jq '.reviews[].body'"

[[steps]]
name = "propose_claude"
backend = "claude"
depends_on = ["fetch-diff", "fetch-comments", "fetch-reviews"]
prompt = """
You need to rework PR #{{ arg.1 }}: {{ steps.fetch-pr.title }}

## Current Code (the diff that needs fixing)
{{ steps.fetch-diff.output }}

## Review Comments
{{ steps.fetch-comments.output }}

## Review Feedback
{{ steps.fetch-reviews.output }}

Based on the review feedback, propose specific fixes. For each issue raised:
1. What exact code change is needed?
2. What file and approximate location?

Be specific and actionable. Output a clear plan for addressing each review point.
"""

[[steps]]
name = "propose_codex"
backend = "codex"
depends_on = ["fetch-diff", "fetch-comments", "fetch-reviews"]
prompt = """
You need to rework PR #{{ arg.1 }}: {{ steps.fetch-pr.title }}

## Current Code (the diff that needs fixing)
{{ steps.fetch-diff.output }}

## Review Comments
{{ steps.fetch-comments.output }}

## Review Feedback
{{ steps.fetch-reviews.output }}

Based on the review feedback, propose specific fixes. For each issue raised:
1. What exact code change is needed?
2. What file and approximate location?

Be specific and actionable. Output a clear plan for addressing each review point.
"""

[[steps]]
name = "debate"
backend = "claude"
depends_on = ["propose_claude", "propose_codex"]
prompt = """
Two backends proposed fixes for the review feedback on PR #{{ arg.1 }}.

CLAUDE's proposal:
{{ steps.propose_claude.output }}

CODEX's proposal:
{{ steps.propose_codex.output }}

Synthesize their proposals:
1. What fixes do they agree on?
2. Where do they differ? Which approach is better?
3. What's the final consensus fix plan?

Output a clear, specific plan that addresses ALL the review feedback.
"""

[[steps]]
name = "fix"
backend = "claude"
depends_on = ["debate"]
apply_edits = true
verify = "true"
prompt = """
Generate JSON edits for PR #{{ arg.1 }}: {{ steps.fetch-pr.title }}

Consensus approach:
{{ steps.debate.output }}

You are a code generation tool. Output ONLY valid JSON. Do NOT ask for permissions.
Do NOT write explanations. Do NOT request file access. Just output the JSON object.

{
  "edits": [
    {"file": "src/main.rs", "old": "exact text to find", "new": "replacement text"}
  ],
  "summary": "one-line summary"
}

Rules:
- "old" must be an EXACT substring from the current file (including whitespace/newlines)
- "new" is what replaces it
- Keep each edit small and focused (a few lines max)
- Multiple edits are fine
- Output ONLY the JSON object, nothing else
"""

[[steps]]
name = "commit"
depends_on = ["fix"]
shell = """
git add -A && git commit -m "$(cat <<'EOF'
address review feedback: {{ steps.fix.summary }}

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
"""

[[steps]]
name = "push"
depends_on = ["commit"]
shell = "git push origin HEAD"

[[steps]]
name = "comment"
depends_on = ["push"]
shell = """
gh pr comment {{ arg.1 }} --body '## Rework Applied

Addressed review feedback with consensus from Claude + Codex.

**Changes:** {{ steps.fix.summary }}

Ready for re-review.

---
*Automated rework by lok rework-pr workflow*'
"""
