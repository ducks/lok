# Review a PR with multi-backend consensus
#
# Usage:
#   lok run review-pr 31
#
# This workflow:
# 1. Fetches PR metadata and diff
# 2. Gets reviews from Claude and Codex in parallel
# 3. Synthesizes findings into a consensus verdict
# 4. Posts a comment to the PR with findings
# 5. Optionally merges if approved

name = "review-pr"
description = "Review a PR with multi-backend consensus and post findings"

[[steps]]
name = "fetch-meta"
shell = "gh pr view {{ arg.1 }} --json number,title,body,additions,deletions,changedFiles,author"

[[steps]]
name = "fetch-diff"
shell = "gh pr diff {{ arg.1 }}"

[[steps]]
name = "review_claude"
backend = "claude"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_codex"
backend = "codex"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_gemini"
backend = "gemini"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
IMPORTANT: Be concise and direct. Do NOT make any tool calls. Do NOT investigate or read files. Work ONLY with the context provided below. Limit your response to 300 words.

You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Review this code change. Check for:
1. Correctness - Does it do what it claims?
2. Bugs - Logic errors, edge cases?
3. Security - Any issues?
4. Completeness - Missing locations that need same fix?

Categorize as Critical/Important/Minor. Be specific with file paths and line numbers.
"""

[[steps]]
name = "synthesize"
backend = "claude"
depends_on = ["review_claude", "review_codex", "review_gemini"]
prompt = """
Three backends reviewed PR #{{ arg.1 }}. Synthesize their findings into a consensus.

CLAUDE review:
{{ steps.review_claude.output }}

CODEX review:
{{ steps.review_codex.output }}

GEMINI review:
{{ steps.review_gemini.output }}

Analyze the reviews and output JSON. Here is the EXACT format to use:

{
  "verdict": "APPROVE",
  "critical": "None",
  "important": "- First important issue\n- Second important issue",
  "minor": "- First minor issue",
  "summary": "Summary sentence here.",
  "followups": [
    {"title": "Issue title", "body": "Issue description", "label": "bug"},
    {"title": "Another issue", "body": "Description", "label": "enhancement"}
  ]
}

CRITICAL RULES:
1. verdict must be exactly one of: APPROVE, NEEDS_WORK, REQUEST_CHANGES
2. critical/important/minor must be STRINGS, not arrays
3. Use "None" if no issues, or "- item one\n- item two" for multiple
4. NEVER use ["item"] array syntax for critical/important/minor - always use string with dashes
5. followups MUST include ALL critical and important issues as separate trackable items
6. Each followup needs: title (short), body (detailed description with file paths), label (bug/enhancement)
7. Output ONLY the JSON, no markdown, no explanation
"""

[[steps]]
name = "comment"
depends_on = ["synthesize"]
shell = """
gh pr comment {{ arg.1 }} --body "$(cat <<'LOKEOF'
## lok Review ({{ workflow.backends }} consensus)

### Verdict: {{ steps.synthesize.verdict }}

{{ steps.synthesize.summary }}

**Critical:** {{ steps.synthesize.critical }}

**Important:** {{ steps.synthesize.important }}

**Minor:** {{ steps.synthesize.minor }}

---
*Automated review by lok review-pr workflow*
LOKEOF
)"
"""

[[steps]]
name = "create_followups"
backend = "claude"
depends_on = ["synthesize"]
prompt = """
The synthesize step found these issues. Create a gh issue command for EACH followup.

Synthesis JSON:
{{ steps.synthesize.output }}

RULES:
1. Create ONE gh issue command for EACH item in the followups array
2. Do NOT skip any followups - every single one must become an issue
3. If followups array is empty, output: echo "No follow-up issues needed"

YOUR OUTPUT MUST BE RAW SHELL COMMANDS ONLY.

DO NOT:
- Wrap in ```bash or ``` code blocks
- Add any markdown formatting
- Add any explanation text
- Use backticks anywhere
- Skip or consolidate followups

DO:
- Output one gh issue create command per followup
- Use single quotes for --body content
- Replace any single quotes in body text with double quotes
- Include the label from each followup

CORRECT OUTPUT EXAMPLE:
gh issue create --title "Fix async conversion" --body 'The file src/foo.rs needs async conversion' --label bug
gh issue create --title "Add tests" --body 'Missing test coverage for bar module' --label enhancement
"""

[[steps]]
name = "run_followups"
depends_on = ["create_followups"]
shell = "{{ steps.create_followups.output }}"
