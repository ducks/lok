# Review a PR with multi-backend consensus
#
# Usage:
#   lok run review-pr 31
#
# This workflow:
# 1. Fetches PR metadata and diff
# 2. Gets reviews from Claude and Codex in parallel
# 3. Synthesizes findings into a consensus verdict
# 4. Posts a comment to the PR with findings
# 5. Optionally merges if approved

name = "review-pr"
description = "Review a PR with multi-backend consensus and post findings"

[[steps]]
name = "fetch-meta"
shell = "gh pr view {{ arg.1 }} --json number,title,body,additions,deletions,changedFiles,author"

[[steps]]
name = "fetch-diff"
shell = "gh pr diff {{ arg.1 }}"

[[steps]]
name = "review_claude"
backend = "claude"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_codex"
backend = "codex"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "synthesize"
backend = "claude"
depends_on = ["review_claude", "review_codex"]
prompt = """
Two backends reviewed PR #{{ arg.1 }}. Synthesize their findings into a consensus.

CLAUDE review:
{{ steps.review_claude.output }}

CODEX review:
{{ steps.review_codex.output }}

Analyze the reviews:
1. What issues did BOTH find? (high confidence)
2. What did only ONE find? (note which)
3. Overall verdict?

Output JSON:
{
  "verdict": "APPROVE or NEEDS_WORK or REQUEST_CHANGES",
  "critical": "bullet list of critical issues or None",
  "important": "bullet list of important issues or None",
  "minor": "bullet list of minor issues or None",
  "summary": "2-3 sentence summary of the review"
}

Only APPROVE if both reviewers found no critical/important issues.
Output only the JSON.
"""

[[steps]]
name = "comment"
depends_on = ["synthesize"]
shell = """
gh pr comment {{ arg.1 }} --body "## lok Review (Claude + Codex consensus)

### Verdict: {{ steps.synthesize.verdict }}

{{ steps.synthesize.summary }}

**Critical:** {{ steps.synthesize.critical }}

**Important:** {{ steps.synthesize.important }}

**Minor:** {{ steps.synthesize.minor }}

---
*Automated review by lok review-pr workflow*"
"""
