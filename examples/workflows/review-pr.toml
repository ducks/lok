# Review a PR with multi-backend consensus
#
# Usage:
#   lok run review-pr 31
#
# This workflow:
# 1. Fetches PR metadata and diff
# 2. Gets reviews from Claude and Codex in parallel
# 3. Synthesizes findings into a consensus verdict
# 4. Posts a comment to the PR with findings
# 5. Optionally merges if approved

name = "review-pr"
description = "Review a PR with multi-backend consensus and post findings"

[[steps]]
name = "fetch-meta"
shell = "gh pr view {{ arg.1 }} --json number,title,body,additions,deletions,changedFiles,author"

[[steps]]
name = "fetch-diff"
shell = "gh pr diff {{ arg.1 }}"

[[steps]]
name = "review_claude"
backend = "claude"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_codex"
backend = "codex"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "synthesize"
backend = "claude"
depends_on = ["review_claude", "review_codex"]
prompt = """
Two backends reviewed PR #{{ arg.1 }}. Synthesize their findings into a consensus.

CLAUDE review:
{{ steps.review_claude.output }}

CODEX review:
{{ steps.review_codex.output }}

Analyze the reviews:
1. What issues did BOTH find? (high confidence)
2. What did only ONE find? (note which)
3. Overall verdict?
4. Are there follow-up issues needed? (e.g., same fix needed in other files)

Output JSON:
{
  "verdict": "APPROVE or NEEDS_WORK or REQUEST_CHANGES",
  "critical": "None OR bullet points as plain text with dashes",
  "important": "None OR bullet points as plain text with dashes",
  "minor": "None OR bullet points as plain text with dashes",
  "summary": "2-3 sentence summary of the review",
  "followups": [
    {"title": "Short issue title", "body": "Description of what needs to be done and where"}
  ]
}

IMPORTANT formatting rules:
- For critical/important/minor: Use plain text with dashes for bullets, NOT JSON arrays
- Example: "- Issue one\n- Issue two" NOT ["Issue one", "Issue two"]
- For followups: Only include if BOTH reviewers identified incomplete work
- If no followups needed, use empty array: "followups": []
Output only the JSON.
"""

[[steps]]
name = "comment"
depends_on = ["synthesize"]
shell = """
gh pr comment {{ arg.1 }} --body "## lok Review (Claude + Codex consensus)

### Verdict: {{ steps.synthesize.verdict }}

{{ steps.synthesize.summary }}

**Critical:** {{ steps.synthesize.critical }}

**Important:** {{ steps.synthesize.important }}

**Minor:** {{ steps.synthesize.minor }}

---
*Automated review by lok review-pr workflow*"
"""

[[steps]]
name = "create_followups"
backend = "claude"
depends_on = ["synthesize"]
prompt = """
Based on this review synthesis, create GitHub issues for any follow-up work needed.

Synthesis:
{{ steps.synthesize.output }}

If there are followups in the JSON, output shell commands to create them.
If no followups needed, output: echo "No follow-up issues needed"

IMPORTANT:
- Output ONLY raw shell commands, NO markdown, NO code blocks, NO backticks
- Use single quotes for the --body to avoid escaping issues
- One command per followup

Example format:
gh issue create --title "Title here" --body 'Body here' --label bug
"""

[[steps]]
name = "run_followups"
depends_on = ["create_followups"]
shell = "{{ steps.create_followups.output }}"
