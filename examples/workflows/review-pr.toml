# Review a PR with multi-backend consensus
#
# Usage:
#   lok run review-pr 31
#
# This workflow:
# 1. Fetches PR metadata and diff
# 2. Gets reviews from Claude and Codex in parallel
# 3. Synthesizes findings into a consensus verdict
# 4. Posts a comment to the PR with findings
# 5. Optionally merges if approved

name = "review-pr"
description = "Review a PR with multi-backend consensus and post findings"

[[steps]]
name = "fetch-meta"
shell = "gh pr view {{ arg.1 }} --json number,title,body,additions,deletions,changedFiles,author"

[[steps]]
name = "fetch-diff"
shell = "gh pr diff {{ arg.1 }}"

[[steps]]
name = "review_claude"
backend = "claude"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_codex"
backend = "codex"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Perform a thorough code review. Check for:
1. Correctness - Does the code do what it claims?
2. Bugs - Are there any logic errors, edge cases, or potential crashes?
3. Security - Any security issues (injection, unsafe operations)?
4. Completeness - Are there other locations that need the same fix?
5. Style - Does it follow project conventions?

Categorize findings as:
- Critical: Will break production or has security issues
- Important: Logic errors, incomplete fixes, missing edge cases
- Minor: Style, naming, small improvements

Be specific with file paths and line numbers.
"""

[[steps]]
name = "review_gemini"
backend = "gemini"
depends_on = ["fetch-meta", "fetch-diff"]
prompt = """
IMPORTANT: Be concise and direct. Do NOT make any tool calls. Do NOT investigate or read files. Work ONLY with the context provided below. Limit your response to 300 words.

You are reviewing PR #{{ arg.1 }}.

## PR Metadata
{{ steps.fetch-meta.output }}

## Code Changes
{{ steps.fetch-diff.output }}

Review this code change. Check for:
1. Correctness - Does it do what it claims?
2. Bugs - Logic errors, edge cases?
3. Security - Any issues?
4. Completeness - Missing locations that need same fix?

Categorize as Critical/Important/Minor. Be specific with file paths and line numbers.
"""

[[steps]]
name = "synthesize"
backend = "claude"
depends_on = ["review_claude", "review_codex", "review_gemini"]
prompt = """
Three backends reviewed PR #{{ arg.1 }}. Synthesize their findings into a consensus.

CLAUDE review:
{{ steps.review_claude.output }}

CODEX review:
{{ steps.review_codex.output }}

GEMINI review:
{{ steps.review_gemini.output }}

Analyze the reviews and output JSON. Here is the EXACT format to use:

{
  "verdict": "APPROVE",
  "critical": "None",
  "important": "- First important issue\n- Second important issue",
  "minor": "- First minor issue",
  "summary": "Summary sentence here.",
  "followups": []
}

CRITICAL RULES:
1. verdict must be exactly one of: APPROVE, NEEDS_WORK, REQUEST_CHANGES
2. critical/important/minor must be STRINGS, not arrays
3. Use "None" if no issues, or "- item one\n- item two" for multiple
4. NEVER use ["item"] array syntax - always use string with dashes
5. followups is an array only if BOTH reviewers found incomplete work
6. Output ONLY the JSON, no markdown, no explanation
"""

[[steps]]
name = "comment"
depends_on = ["synthesize"]
shell = """
gh pr comment {{ arg.1 }} --body "$(cat <<'LOKEOF'
## lok Review ({{ workflow.backends }} consensus)

### Verdict: {{ steps.synthesize.verdict }}

{{ steps.synthesize.summary }}

**Critical:** {{ steps.synthesize.critical }}

**Important:** {{ steps.synthesize.important }}

**Minor:** {{ steps.synthesize.minor }}

---
*Automated review by lok review-pr workflow*
LOKEOF
)"
"""

[[steps]]
name = "create_followups"
backend = "claude"
depends_on = ["synthesize"]
prompt = """
Based on this review synthesis, create GitHub issues for any follow-up work needed.

Synthesis:
{{ steps.synthesize.output }}

If there are followups in the JSON, output shell commands to create them.
If no followups needed, output exactly: echo "No follow-up issues needed"

YOUR OUTPUT MUST BE RAW SHELL COMMANDS ONLY.

DO NOT:
- Wrap in ```bash or ``` code blocks
- Add any markdown formatting
- Add any explanation text
- Use backticks anywhere

DO:
- Output raw gh commands directly
- Use single quotes for --body content
- Avoid single quotes in the body text itself

CORRECT OUTPUT EXAMPLE:
gh issue create --title "Fix X" --body 'Description here' --label bug

WRONG OUTPUT (DO NOT DO THIS):
```bash
gh issue create --title "Fix X" --body 'Description'
```
"""

[[steps]]
name = "run_followups"
depends_on = ["create_followups"]
shell = "{{ steps.create_followups.output }}"
