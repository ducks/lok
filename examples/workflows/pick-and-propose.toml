# Pick an issue and get multi-backend consensus on how to fix it
#
# Usage:
#   lok run pick-and-propose
#
# This workflow:
# 1. Fetches open issues (excluding those with open PRs)
# 2. Has Claude pick the best one to fix
# 3. Gets fix proposals from multiple backends
# 4. Backends debate and converge on the best approach
# 5. Outputs the consensus plan for the conductor to implement

name = "pick-and-propose"
description = "Pick an issue and get multi-backend consensus on the fix approach"

[[steps]]
name = "list"
shell = "gh issue list --limit 50 --json number,title,body,labels"

[[steps]]
name = "open_prs"
shell = "gh pr list --json number,title,body --jq '[.[] | {number, title, body}]'"

[[steps]]
name = "pick"
backend = "claude"
depends_on = ["list", "open_prs"]
prompt = """
Here are the open issues for this repo:

{{ steps.list.output }}

These PRs are already open (skip issues they reference):

{{ steps.open_prs.output }}

Pick the ONE issue that:
1. Does NOT already have an open PR (check PR titles/bodies for "Closes #N" or "issue N")
2. Is clearly defined (not vague or sprawling)
3. Can be fixed with a focused code change
4. Won't require major refactoring

If issues have priority labels (P0/P1/P2/P3), prefer higher priority.

Output JSON:
{
  "number": 123,
  "title": "issue title",
  "reason": "why this is the best pick"
}

Pick only ONE. Output only the JSON.
"""

[[steps]]
name = "fetch"
depends_on = ["pick"]
shell = "gh issue view {{ steps.pick.number }} --json body,comments"

[[steps]]
name = "propose_claude"
backend = "claude"
depends_on = ["fetch"]
prompt = """
Propose a fix for this issue:

Issue #{{ steps.pick.number }}: {{ steps.pick.title }}

Details:
{{ steps.fetch.output }}

Read the relevant code and propose the APPROACH to fix this.
Don't output JSON yet - just explain:
1. What's the root cause?
2. What files need to change?
3. What's your proposed fix?

Be specific but concise.
"""

[[steps]]
name = "propose_codex"
backend = "codex"
depends_on = ["fetch"]
prompt = """
Propose a fix for this issue:

Issue #{{ steps.pick.number }}: {{ steps.pick.title }}

Details:
{{ steps.fetch.output }}

Read the relevant code and propose the APPROACH to fix this.
Don't output JSON yet - just explain:
1. What's the root cause?
2. What files need to change?
3. What's your proposed fix?

Be specific but concise.
"""

[[steps]]
name = "debate"
backend = "claude"
depends_on = ["propose_claude", "propose_codex"]
prompt = """
Two AI backends proposed fixes for Issue #{{ steps.pick.number }}: {{ steps.pick.title }}

CLAUDE's proposal:
{{ steps.propose_claude.output }}

CODEX's proposal:
{{ steps.propose_codex.output }}

Analyze both proposals:
1. What do they agree on?
2. Where do they differ?
3. Which approach is better and why?
4. What's the FINAL consensus approach?

Output a clear, specific plan for the fix that incorporates the best ideas from both.
Be specific about which files to change and what the changes should be.
"""
